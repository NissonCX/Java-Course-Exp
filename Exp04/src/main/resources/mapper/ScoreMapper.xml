<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cqu.exp04.mapper.ScoreMapper">

    <resultMap id="ScoreResultMap" type="com.cqu.exp04.entity.Score">
        <id property="id" column="id"/>
        <result property="enrollmentId" column="enrollment_id"/>
        <result property="studentId" column="student_id"/>
        <result property="teachingClassId" column="teaching_class_id"/>
        <result property="usualScore" column="usual_score"/>
        <result property="midtermScore" column="midterm_score"/>
        <result property="experimentScore" column="experiment_score"/>
        <result property="finalScore" column="final_score"/>
        <result property="totalScore" column="total_score"/>
        <result property="gradePoint" column="grade_point"/>
        <result property="usualScoreTime" column="usual_score_time"/>
        <result property="midtermScoreTime" column="midterm_score_time"/>
        <result property="experimentScoreTime" column="experiment_score_time"/>
        <result property="finalScoreTime" column="final_score_time"/>
        <result property="totalScoreTime" column="total_score_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap id="ScoreWithStudentResultMap" type="com.cqu.exp04.entity.Score" extends="ScoreResultMap">
        <association property="student" javaType="com.cqu.exp04.entity.Student">
            <id property="id" column="s_id"/>
            <result property="studentNo" column="student_no"/>
            <result property="name" column="s_name"/>
            <result property="major" column="major"/>
        </association>
    </resultMap>

    <select id="findById" resultMap="ScoreResultMap">
        SELECT * FROM score WHERE id = #{id}
    </select>

    <select id="findByEnrollmentId" resultMap="ScoreResultMap">
        SELECT * FROM score WHERE enrollment_id = #{enrollmentId}
    </select>

    <select id="findByStudentId" resultMap="ScoreResultMap">
        SELECT * FROM score WHERE student_id = #{studentId} ORDER BY create_time DESC
    </select>

    <select id="findByTeachingClassId" resultMap="ScoreResultMap">
        SELECT * FROM score WHERE teaching_class_id = #{teachingClassId} ORDER BY total_score DESC
    </select>

    <select id="findStudentScoreDetails" resultType="com.cqu.exp04.vo.StudentScoreVO">
        SELECT
            s.id as scoreId,
            c.course_no as courseNo,
            c.course_name as courseName,
            c.credit,
            t.name as teacherName,
            tc.class_no as classNo,
            tc.semester,
            s.usual_score as usualScore,
            s.midterm_score as midtermScore,
            s.experiment_score as experimentScore,
            s.final_score as finalScore,
            s.total_score as totalScore,
            s.grade_point as gradePoint,
            s.total_score_time as totalScoreTime
        FROM score s
        JOIN teaching_class tc ON s.teaching_class_id = tc.id
        JOIN course c ON tc.course_id = c.id
        JOIN teacher t ON tc.teacher_id = t.id
        WHERE s.student_id = #{studentId}
        ORDER BY tc.semester DESC, c.course_name
    </select>

    <select id="findClassScoresWithStudent" resultMap="ScoreWithStudentResultMap">
        SELECT
            s.*,
            st.id as s_id,
            st.student_no,
            st.name as s_name,
            st.major
        FROM score s
        JOIN student st ON s.student_id = st.id
        WHERE s.teaching_class_id = #{teachingClassId}
        ORDER BY s.total_score DESC
    </select>

    <insert id="insert" parameterType="com.cqu.exp04.entity.Score" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO score (
            enrollment_id, student_id, teaching_class_id,
            usual_score, midterm_score, experiment_score, final_score,
            total_score, grade_point,
            usual_score_time, midterm_score_time, experiment_score_time,
            final_score_time, total_score_time
        ) VALUES (
            #{enrollmentId}, #{studentId}, #{teachingClassId},
            #{usualScore}, #{midtermScore}, #{experimentScore}, #{finalScore},
            #{totalScore}, #{gradePoint},
            #{usualScoreTime}, #{midtermScoreTime}, #{experimentScoreTime},
            #{finalScoreTime}, #{totalScoreTime}
        )
    </insert>

    <update id="update" parameterType="com.cqu.exp04.entity.Score">
        UPDATE score
        <set>
            <if test="usualScore != null">usual_score = #{usualScore},</if>
            <if test="midtermScore != null">midterm_score = #{midtermScore},</if>
            <if test="experimentScore != null">experiment_score = #{experimentScore},</if>
            <if test="finalScore != null">final_score = #{finalScore},</if>
            <if test="totalScore != null">total_score = #{totalScore},</if>
            <if test="gradePoint != null">grade_point = #{gradePoint},</if>
            <if test="usualScoreTime != null">usual_score_time = #{usualScoreTime},</if>
            <if test="midtermScoreTime != null">midterm_score_time = #{midtermScoreTime},</if>
            <if test="experimentScoreTime != null">experiment_score_time = #{experimentScoreTime},</if>
            <if test="finalScoreTime != null">final_score_time = #{finalScoreTime},</if>
            <if test="totalScoreTime != null">total_score_time = #{totalScoreTime},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM score WHERE id = #{id}
    </delete>

    <select id="calculateStudentAverageScore" resultType="java.lang.Double">
        SELECT AVG(total_score)
        FROM score
        WHERE student_id = #{studentId} AND total_score IS NOT NULL
    </select>

</mapper>
