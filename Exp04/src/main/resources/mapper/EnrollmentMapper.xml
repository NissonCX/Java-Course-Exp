<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cqu.exp04.mapper.EnrollmentMapper">

    <resultMap id="EnrollmentResultMap" type="com.cqu.exp04.entity.Enrollment">
        <id property="id" column="id"/>
        <result property="studentId" column="student_id"/>
        <result property="teachingClassId" column="teaching_class_id"/>
        <result property="enrollTime" column="enroll_time"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap id="EnrollmentWithDetailsResultMap" type="com.cqu.exp04.entity.Enrollment" extends="EnrollmentResultMap">
        <association property="student" javaType="com.cqu.exp04.entity.Student">
            <id property="id" column="s_id"/>
            <result property="studentNo" column="student_no"/>
            <result property="name" column="s_name"/>
            <result property="major" column="major"/>
            <result property="className" column="class_name"/>
        </association>
        <association property="teachingClass" javaType="com.cqu.exp04.entity.TeachingClass">
            <id property="id" column="tc_id"/>
            <result property="classNo" column="class_no"/>
            <result property="semester" column="semester"/>
            <result property="classroom" column="classroom"/>
            <result property="schedule" column="schedule"/>
            <association property="course" javaType="com.cqu.exp04.entity.Course">
                <id property="id" column="c_id"/>
                <result property="courseNo" column="course_no"/>
                <result property="courseName" column="course_name"/>
                <result property="credit" column="credit"/>
                <result property="hours" column="hours"/>
            </association>
            <association property="teacher" javaType="com.cqu.exp04.entity.Teacher">
                <id property="id" column="t_id"/>
                <result property="teacherNo" column="teacher_no"/>
                <result property="name" column="t_name"/>
                <result property="title" column="title"/>
            </association>
        </association>
    </resultMap>

    <select id="findById" resultMap="EnrollmentWithDetailsResultMap">
        SELECT
            e.*,
            s.id as s_id, s.student_no, s.name as s_name, s.major, s.class_name,
            tc.id as tc_id, tc.class_no, tc.semester, tc.classroom, tc.schedule,
            c.id as c_id, c.course_no, c.course_name, c.credit, c.hours,
            t.id as t_id, t.teacher_no, t.name as t_name, t.title
        FROM enrollment e
        LEFT JOIN student s ON e.student_id = s.id
        LEFT JOIN teaching_class tc ON e.teaching_class_id = tc.id
        LEFT JOIN course c ON tc.course_id = c.id
        LEFT JOIN teacher t ON tc.teacher_id = t.id
        WHERE e.id = #{id}
    </select>

    <select id="findByStudentId" resultMap="EnrollmentWithDetailsResultMap">
        SELECT
            e.*,
            s.id as s_id, s.student_no, s.name as s_name, s.major, s.class_name,
            tc.id as tc_id, tc.class_no, tc.semester, tc.classroom, tc.schedule,
            c.id as c_id, c.course_no, c.course_name, c.credit, c.hours,
            t.id as t_id, t.teacher_no, t.name as t_name, t.title
        FROM enrollment e
        LEFT JOIN student s ON e.student_id = s.id
        LEFT JOIN teaching_class tc ON e.teaching_class_id = tc.id
        LEFT JOIN course c ON tc.course_id = c.id
        LEFT JOIN teacher t ON tc.teacher_id = t.id
        WHERE e.student_id = #{studentId}
        ORDER BY e.enroll_time DESC
    </select>

    <select id="findByTeachingClassId" resultMap="EnrollmentWithDetailsResultMap">
        SELECT
            e.*,
            s.id as s_id, s.student_no, s.name as s_name, s.major, s.class_name,
            tc.id as tc_id, tc.class_no, tc.semester, tc.classroom, tc.schedule,
            c.id as c_id, c.course_no, c.course_name, c.credit, c.hours,
            t.id as t_id, t.teacher_no, t.name as t_name, t.title
        FROM enrollment e
        LEFT JOIN student s ON e.student_id = s.id
        LEFT JOIN teaching_class tc ON e.teaching_class_id = tc.id
        LEFT JOIN course c ON tc.course_id = c.id
        LEFT JOIN teacher t ON tc.teacher_id = t.id
        WHERE e.teaching_class_id = #{teachingClassId}
        ORDER BY s.student_no
    </select>

    <select id="findByStudentAndClass" resultMap="EnrollmentResultMap">
        SELECT * FROM enrollment
        WHERE student_id = #{studentId} AND teaching_class_id = #{teachingClassId}
    </select>

    <insert id="insert" parameterType="com.cqu.exp04.entity.Enrollment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO enrollment (
            student_id, teaching_class_id, enroll_time, status
        ) VALUES (
            #{studentId}, #{teachingClassId}, #{enrollTime}, #{status}
        )
    </insert>

    <insert id="batchInsert">
        INSERT INTO enrollment (
            student_id, teaching_class_id, enroll_time, status
        ) VALUES
        <foreach collection="enrollments" item="item" separator=",">
            (#{item.studentId}, #{item.teachingClassId}, #{item.enrollTime}, #{item.status})
        </foreach>
    </insert>

    <update id="update" parameterType="com.cqu.exp04.entity.Enrollment">
        UPDATE enrollment
        <set>
            <if test="status != null">status = #{status},</if>
            <if test="enrollTime != null">enroll_time = #{enrollTime},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM enrollment WHERE id = #{id}
    </delete>

</mapper>
