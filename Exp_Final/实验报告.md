# 实验报告

## 三、实验过程或算法

### 1. 软件功能

本系统是一个基于 Web 的学生成绩管理系统，分为学生端和教师端，并集成了 AI 辅助功能。

**功能组织图：**

*   **系统入口**
    *   登录
    *   注册（学生/教师）
*   **学生端**
    *   **成绩查询**：查看各科成绩、绩点、平均分。
    *   **选课管理**：
        *   选课大厅：浏览可选课程，进行选课。
        *   选课中心：查看已选课程，退课。
    *   **AI 学业顾问**：基于成绩数据的智能问答。
    *   **个人中心**：查看和修改个人信息。
*   **教师端**
    *   **班级管理**：查看教学班列表。
    *   **成绩管理**：
        *   在线录入/修改成绩（平时、期中、实验、期末）。
        *   批量保存成绩。
        *   查看班级成绩统计（及格率、优秀率等）。
    *   **AI 教学分析**：针对班级成绩进行智能分析。
    *   **个人中心**：查看和修改个人信息。
*   **管理员端**
    *   **学生管理**：创建新学生账号和档案信息。
    *   **教师管理**：创建新教师账号和档案信息。
    *   **课程管理**：创建和管理课程信息。
    *   **教学班管理**：为课程分配授课教师，设置教学班信息。

### 2. 创新点或特色

1.  **AI 深度集成**：引入 LangChain4j 框架接入大语言模型（通义千问），实现了基于真实业务数据的 AI 咨询功能。
    *   学生可以询问 AI "我哪门课考得最差？"、"如何提高 Java 成绩？"，AI 会读取学生的实际成绩数据进行个性化回答。
    *   教师可以让 AI 分析某个班级的成绩分布，提供教学改进建议。
2.  **流式响应 (SSE)**：AI 对话采用 Server-Sent Events (SSE) 技术，实现了打字机效果的流式输出，提升了用户体验。
3.  **前后端分离架构**：虽然部署在同一个 Spring Boot 应用中，但前端采用纯 HTML/JS 调用 RESTful API 的方式，实现了逻辑上的分离。

### 3. 总体设计思想

采用经典的 **MVC (Model-View-Controller)** 设计模式和 **分层架构**。
*   **Controller 层**：处理 HTTP 请求，参数校验，返回统一格式的 JSON 响应。
*   **Service 层**：处理业务逻辑（如选课冲突检测、成绩计算、AI 上下文构建）。
*   **Mapper (DAO) 层**：使用 MyBatis 进行数据库交互。
*   **Entity/DTO/VO**：分别对应数据库实体、数据传输对象、视图对象，实现数据模型的解耦。

### 4. 设计模式的使用

1.  **单例模式 (Singleton)**：Spring Bean 默认单例，如 Service 和 Controller。
2.  **策略模式 (Strategy)**：Spring Security 中的认证策略。
3.  **工厂模式 (Factory)**：MyBatis 的 `SqlSessionFactory`。
4.  **DTO/VO 模式**：用于不同层级间的数据传输，避免直接暴露数据库实体。

### 5. 程序的结构或者架构

**代码组织结构：**
```
com.cqu.exp04
├── config          // 配置类 (Security, LangChain4j)
├── controller      // 控制器 (API 接口)
├── dto             // 数据传输对象 (接收前端参数)
├── entity          // 数据库实体
├── exception       // 全局异常处理
├── mapper          // MyBatis Mapper 接口
├── security        // JWT 认证相关
├── service         // 业务逻辑接口及实现
└── vo              // 视图对象 (返回前端数据)
```

**部署架构：**
单体应用架构，Spring Boot 内置 Tomcat 容器，前端静态资源打包在 jar 包中，数据库使用 MySQL。

### 6. 程序主要执行流程图

**登录流程图：**
``mermaid
graph TD
    A[用户输入用户名密码] --> B[AuthController接收登录请求]
    B --> C[AuthService调用AuthenticationManager进行认证]
    C --> D{认证是否成功?}
    D -->|否| E[返回认证失败信息]
    D -->|是| F[生成JWT Token]
    F --> G[返回Token给前端]
    G --> H[前端存储Token到LocalStorage]
    H --> I[登录成功，跳转到对应仪表板]
```

**选课流程图：**
``mermaid
graph TD
    A[学生发起选课请求] --> B[StudentController接收请求]
    B --> C[StudentService验证教学班是否存在]
    C --> D{教学班是否存在?}
    D -->|否| E[返回教学班不存在错误]
    D -->|是| F[验证教学班是否允许选课(未开课状态)]
    F --> G{教学班是否允许选课?}
    G -->|否| H[返回教学班状态不允许选课错误]
    G -->|是| I[验证是否已选过该课]
    I --> J{是否已选过该课?}
    J -->|是| K[返回已选课错误]
    J -->|否| L[验证教学班是否已满]
    L --> M{教学班是否已满?}
    M -->|是| N[返回教学班已满错误]
    M -->|否| O[创建选课记录]
    O --> P[更新教学班当前人数(并发安全)]
    P --> Q[返回选课成功信息]
```

**AI咨询流程图：**
``mermaid
graph TD
    A[用户发起AI咨询请求] --> B[Controller接收请求]
    B --> C[Service查询相关业务数据]
    C --> D[构建上下文信息作为提示词]
    D --> E[调用AI模型生成回答]
    E --> F[返回AI响应给用户]
```

**成绩录入流程图：**
``mermaid
graph TD
    A[教师录入成绩] --> B[TeacherController接收请求]
    B --> C[验证教师权限]
    C --> D{是否有权限操作此教学班?}
    D -->|否| E[返回权限不足错误]
    D -->|是| F[ScoreService处理成绩录入]
    F --> G[检查选课记录是否存在]
    G --> H{选课记录是否存在?}
    H -->|否| I[返回选课记录不存在错误]
    H -->|是| J[创建或更新成绩记录]
    J --> K[计算总分和绩点]
    K --> L[保存成绩到数据库]
    L --> M[返回录入成功信息]
```

**管理员创建学生流程图：**
``mermaid
graph TD
    A[管理员填写学生信息] --> B[Admin Controller接收请求]
    B --> C[验证学生信息格式]
    C --> D{学号是否已存在?}
    D -->|是| E[返回学号已存在错误]
    D -->|否| F{用户名是否已存在?}
    F -->|是| G[返回用户名已存在错误]
    F -->|否| H[创建用户记录]
    H --> I[创建学生档案记录]
    I --> J[返回创建成功信息]
```

**管理员创建教学班流程图：**
``mermaid
graph TD
    A[管理员填写教学班信息] --> B[Admin Controller接收请求]
    B --> C[验证课程是否存在]
    C --> D{课程是否存在?}
    D -->|否| E[返回课程不存在错误]
    D -->|是| F[验证教师是否存在]
    F --> G{教师是否存在?}
    G -->|否| H[返回教师不存在错误]
    G -->|是| I[验证教学班编号是否重复]
    I --> J{教学班编号是否已存在?}
    J -->|是| K[返回教学班编号已存在错误]
    J -->|否| L[创建教学班记录]
    L --> M[返回创建成功信息]
```

### 7. 前后端交互接口设计

采用 RESTful 风格 API，统一响应格式 `Result<T>`。

*   `POST /api/auth/login`: 登录
*   `GET /api/student/scores`: 获取成绩
*   `POST /api/student/enroll`: 选课
*   `POST /api/teacher/score/input`: 录入成绩
*   `GET /api/teacher/ai/consult/stream`: AI 流式咨询

### 8. 安全设计

1.  **JWT (JSON Web Token)**：实现无状态认证。每次请求在 Header 中携带 `Authorization: Bearer <token>`。
2.  **Spring Security**：配置安全过滤器链，对不同路径进行权限控制（如 `/api/student/**` 仅限学生访问）。
3.  **密码加密**：使用 `BCryptPasswordEncoder` 对用户密码进行哈希加密存储。

### 9. SpringBoot 的详细使用说明

*   **依赖管理**：使用 Maven 管理 `spring-boot-starter-web`, `mybatis-spring-boot-starter`, `spring-boot-starter-security` 等。
*   **配置文件**：使用 `application.yaml` 配置端口、数据库连接、MyBatis 路径、日志级别等。
*   **自动配置**：利用 Spring Boot 的自动配置特性，简化了 MyBatis 和 Web MVC 的配置。

### 10. 实体类和数据库表的详细设计

主要实体包括：
*   `User`: 用户基类（账号、密码、角色）
*   `Student`: 学生信息
*   `Teacher`: 教师信息
*   `Course`: 课程信息
*   `TeachingClass`: 教学班（关联课程和教师）
*   `Enrollment`: 选课记录（关联学生和教学班）
*   `Score`: 成绩记录

### 11. 前端功能详细分析

#### 11.1 学生端前端功能

学生端前端采用纯 HTML、CSS 和 JavaScript 实现，主要功能模块包括：

**11.1.1 成绩查询功能**
- **页面结构**：位于 [student.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/student.html) 中的 `#view-scores` 区域
- **功能实现**：使用 JavaScript [student.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/student.js) 中的 `loadScores()` 函数，通过 API 调用获取学生成绩数据
- **数据展示**：
  - 统计信息：平均分、平均绩点、修读学分、课程总数
  - 详细表格：展示每门课程的成绩构成（平时、期中、实验、期末）及总评
  - 图表可视化：使用 Chart.js 实现成绩分布柱状图、学科能力雷达图和成绩等级环形图

**11.1.2 选课管理功能**
- **页面结构**：位于 [student.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/student.html) 中的 `#view-course-manage` 区域
- **功能实现**：包含两个标签页（Tab）
  - 已选课程：展示学生已选课程列表，支持退课操作
  - 选课大厅：支持按学期查询可选课程，提供选课按钮
- **交互逻辑**：通过 [student.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/student.js) 中的 `loadAvailableCourses()` 和 `loadEnrollments()` 函数实现数据加载

**11.1.3 AI 学业顾问功能**
- **页面结构**：位于 [student.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/student.html) 中的 `#view-ai-advisor` 区域
- **功能实现**：实现聊天界面，支持流式响应
- **交互逻辑**：
  - 发送消息时调用 `handleSendMessage()` 函数
  - 通过 SSE (Server-Sent Events) 实现流式响应，使用 `fetch` API 连接到后端的 `/student/ai/consult/stream` 端点
  - 使用 marked.js 库处理 AI 返回的 Markdown 格式内容

**11.1.4 个人信息管理功能**
- **页面结构**：位于 [student.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/student.html) 中的 `#view-profile` 区域
- **功能实现**：展示学生基本信息（学号、姓名、班级等），支持修改邮箱和电话
- **交互逻辑**：通过 [student.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/student.js) 中的 `loadProfile()` 和表单提交事件处理实现

#### 11.2 教师端前端功能

教师端前端同样采用纯 HTML、CSS 和 JavaScript 实现，主要功能模块包括：

**11.2.1 我的教学班功能**
- **页面结构**：位于 [teacher.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/teacher.html) 中的 `#view-classes` 区域
- **功能实现**：以卡片形式展示教师的所有教学班，显示课程名称、教学班号、选课人数等信息
- **交互逻辑**：支持点击卡片进入班级详情页，支持修改教学班状态（未开课、已开课、已结课）

**11.2.2 班级成绩管理功能**
- **页面结构**：位于 [teacher.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/teacher.html) 中的 `#view-class-detail` 区域
- **功能实现**：
  - 展示班级统计信息（平均分、及格率、最高分、优秀率）
  - 提供成绩录入表格，支持录入平时、期中、实验、期末成绩
  - 支持单行保存和批量保存功能
- **交互逻辑**：通过 [teacher.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/teacher.js) 中的 `loadClassScores()` 和 `saveRowScore()` 等函数实现

**11.2.3 AI 教学分析功能**
- **页面结构**：位于 [teacher.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/teacher.html) 中的 `#view-analysis` 区域
- **功能实现**：提供选择教学班下拉框和聊天界面
- **交互逻辑**：
  - 通过 [teacher.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/teacher.js) 中的 `handleAnalysis()` 函数处理分析请求
  - 使用 SSE 连接到后端的 `/teacher/ai/consult/stream` 端点获取流式响应

**11.2.4 个人信息管理功能**
- **页面结构**：位于 [teacher.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/teacher.html) 中的 `#view-profile` 区域
- **功能实现**：展示教师基本信息，支持修改邮箱和电话
- **交互逻辑**：通过 [teacher.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/teacher.js) 中的相关函数实现

#### 11.3 前端技术特点

**11.3.1 前端架构特点**
- **单页应用（SPA）**：通过 JavaScript 动态切换页面内容，无需刷新整个页面
- **组件化设计**：使用独立的 JavaScript 函数处理不同功能模块
- **响应式设计**：使用 CSS Grid 和 Flexbox 实现响应式布局

**11.3.2 前端数据处理**
- **API 调用**：通过统一的 [api.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/api.js) 模块封装 HTTP 请求
- **状态管理**：使用浏览器 LocalStorage 存储 JWT Token 和用户信息
- **数据渲染**：使用 DOM 操作动态渲染表格和图表

**11.3.3 前端可视化功能**
- **图表库集成**：使用 Chart.js 实现多种图表类型（柱状图、雷达图、环形图）
- **实时更新**：图表数据随数据加载实时更新
- **交互式图表**：支持鼠标悬停提示等交互功能

#### 11.4 管理员端前端功能

**11.4.1 管理员主界面**
- **页面结构**：位于 [admin.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/admin.html) 中，采用与学生端、教师端相似的布局设计
- **功能模块**：包含四个主要功能区域（新增学生、新增教师、新增课程、新增教学班）
- **权限验证**：通过 [admin.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/admin.js) 验证用户角色为 SUPER_ADMIN

**11.4.2 学生管理功能**
- **页面结构**：位于 [admin.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/admin.html) 中的 `#view-create-student` 区域
- **功能实现**：通过 [admin.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/admin.js) 中的 `createStudentForm` 表单处理学生创建逻辑
- **数据验证**：包含学号格式验证（10位数字）、必填字段验证等
- **结果展示**：创建成功后在右侧区域显示学生记录详情

**11.4.3 教师管理功能**
- **页面结构**：位于 [admin.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/admin.html) 中的 `#view-create-teacher` 区域
- **功能实现**：通过 [admin.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/admin.js) 中的 `createTeacherForm` 表单处理教师创建逻辑
- **数据验证**：包含教工号格式验证（T开头4位数字）、必填字段验证等
- **结果展示**：创建成功后在右侧区域显示教师记录详情

**11.4.4 课程管理功能**
- **页面结构**：位于 [admin.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/admin.html) 中的 `#view-create-course` 区域
- **功能实现**：通过 [admin.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/admin.js) 中的 `createCourseForm` 表单处理课程创建逻辑
- **数据验证**：包含学分和学时的数值验证、必填字段验证等
- **结果展示**：创建成功后在右侧区域显示课程记录详情

**11.4.5 教学班管理功能**
- **页面结构**：位于 [admin.html](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/admin.html) 中的 `#view-create-teaching-class` 区域
- **功能实现**：通过 [admin.js](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/static/js/admin.js) 中的 `createTeachingClassForm` 表单处理教学班创建逻辑
- **数据加载**：动态加载课程列表和教师列表供选择
- **状态管理**：支持设置教学班状态（未开课/已开课/已结课）
- **结果展示**：创建成功后在右侧区域显示教学班记录详情

### 12. 后端功能详细分析

#### 12.1 核心业务逻辑实现

**12.1.1 用户认证与授权**
- **认证流程**：使用 Spring Security 和 JWT 实现用户认证
- **控制器**：[AuthController](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/controller/AuthController.java) 处理登录、注册请求
- **服务实现**：[AuthServiceImpl](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/service/impl/AuthServiceImpl.java) 负责用户验证和 Token 生成
- **安全过滤器**：[JwtAuthenticationFilter](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/security/JwtAuthenticationFilter.java) 拦截请求并验证 JWT Token

**12.1.2 学生服务实现**
- **主要功能**：[StudentServiceImpl](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/service/impl/StudentServiceImpl.java) 实现学生端核心业务逻辑
- **成绩查询**：通过 [ScoreMapper](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/mapper/ScoreMapper.java) 查询学生成绩数据，计算平均分和 GPA
- **选课管理**：实现选课和退课逻辑，包括验证教学班状态、检查选课冲突、更新选课人数等
- **数据验证**：在关键操作前进行数据验证，如检查教学班是否可选、是否已选课、教学班是否已满等

以下为选课功能的核心实现代码：

```java
@Override
@Transactional
public void enrollCourse(Long studentId, Long teachingClassId) {
    // 1. 检查教学班是否存在
    TeachingClass teachingClass = teachingClassMapper.findByIdWithDetails(teachingClassId)
            .orElseThrow(() -> new RuntimeException("教学班不存在"));

    // 2. 检查教学班是否允许选课（只允许"未开课"状态选课）
    if (!teachingClass.isSelectableForEnrollment()) {
        throw new RuntimeException("该教学班" + teachingClass.getStatusText() + "，当前不允许选课");
    }

    // 3. 检查是否已选课
    if (enrollmentMapper.findByStudentAndClass(studentId, teachingClassId).isPresent()) {
        throw new RuntimeException("您已经选过这门课了");
    }

    // 4. 检查教学班是否已满
    if (teachingClass.getCurrentStudents() >= teachingClass.getMaxStudents()) {
        throw new RuntimeException("教学班已满,无法选课");
    }

    // 5. 创建选课记录
    Enrollment enrollment = Enrollment.builder()
            .studentId(studentId)
            .teachingClassId(teachingClassId)
            .enrollTime(LocalDateTime.now())
            .status(1)  // 1-正常
            .build();
    enrollmentMapper.insert(enrollment);

    // 5. 更新教学班当前人数（并发安全：未满员才 +1）
    int updated = teachingClassMapper.incrementCurrentStudentsIfNotFull(teachingClassId);
    if (updated != 1) {
        throw new RuntimeException("教学班已满,无法选课");
    }
}
```

**12.1.3 教师服务实现**
- **主要功能**：[TeacherServiceImpl](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/service/impl/TeacherServiceImpl.java) 实现教师端核心业务逻辑
- **班级管理**：提供教学班列表、班级学生信息查询等功能
- **成绩管理**：通过 [ScoreService](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/service/ScoreService.java) 实现成绩录入和批量录入
- **权限控制**：在每个操作前验证教师是否有权限访问特定教学班

以下为教师服务中获取班级学生信息的核心实现代码：

```java
@Override
public List<Map<String, Object>> getClassStudents(Long teacherId, Long teachingClassId) {
    // 1. 验证权限
    TeachingClass teachingClass = teachingClassMapper.findByIdWithDetails(teachingClassId)
            .orElseThrow(() -> new RuntimeException("教学班不存在"));

    if (!teachingClass.getTeacherId().equals(teacherId)) {
        throw new RuntimeException("无权限查看此教学班");
    }

    // 2. 查询教学班的所有选课记录
    return enrollmentMapper.findByTeachingClassId(teachingClassId).stream()
            .map(enrollment -> {
                Map<String, Object> map = new HashMap<>();
                map.put("enrollmentId", enrollment.getId());
                map.put("studentId", enrollment.getStudentId());
                map.put("studentNo", enrollment.getStudent().getStudentNo());
                map.put("studentName", enrollment.getStudent().getName());
                map.put("gender", enrollment.getStudent().getGender());
                map.put("major", enrollment.getStudent().getMajor());
                map.put("className", enrollment.getStudent().getClassName());
                map.put("enrollTime", enrollment.getEnrollTime());

                // 查询成绩
                scoreMapper.findByEnrollmentId(enrollment.getId()).ifPresentOrElse(
                        score -> {
                            map.put("hasScore", true);
                            map.put("usualScore", score.getUsualScore());
                            map.put("midtermScore", score.getMidtermScore());
                            map.put("experimentScore", score.getExperimentScore());
                            map.put("finalScore", score.getFinalScore());
                            map.put("totalScore", score.getTotalScore());
                            map.put("gradePoint", score.getGradePoint());
                        },
                        () -> map.put("hasScore", false)
                );

                return map;
            })
            .collect(Collectors.toList());
}
```

**12.1.4 成绩管理服务**
- **主要功能**：[ScoreService](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/service/ScoreService.java) 负责成绩录入、计算和统计
- **成绩计算**：根据平时、期中、实验、期末成绩按权重计算总分和绩点
- **统计分析**：提供班级成绩统计信息，包括平均分、最高分、最低分、及格率等

以下为成绩录入和计算的核心实现代码：

```
/**
 * 录入/更新成绩
 */
@Transactional
public void inputScore(Long teacherId, ScoreInputRequest request) {
    // 验证教师权限
    TeachingClass teachingClass = teachingClassMapper.findByIdWithDetails(request.getTeachingClassId())
            .orElseThrow(() -> new RuntimeException("教学班不存在"));

    if (!teachingClass.getTeacherId().equals(teacherId)) {
        throw new RuntimeException("无权限操作此教学班");
    }

    // 查找选课记录
    Enrollment enrollment = enrollmentMapper.findByStudentAndClass(
            request.getStudentId(), request.getTeachingClassId())
            .orElseThrow(() -> new RuntimeException("选课记录不存在"));

    // 查找或创建成绩记录
    Score score = scoreMapper.findByEnrollmentId(enrollment.getId())
            .orElseGet(() -> {
                Score newScore = new Score();
                newScore.setEnrollmentId(enrollment.getId());
                newScore.setStudentId(request.getStudentId());
                newScore.setTeachingClassId(request.getTeachingClassId());
                return newScore;
            });

    LocalDateTime now = LocalDateTime.now();

    // 更新各项成绩
    if (request.getUsualScore() != null) {
        score.setUsualScore(request.getUsualScore());
        score.setUsualScoreTime(now);
    }
    if (request.getMidtermScore() != null) {
        score.setMidtermScore(request.getMidtermScore());
        score.setMidtermScoreTime(now);
    }
    if (request.getExperimentScore() != null) {
        score.setExperimentScore(request.getExperimentScore());
        score.setExperimentScoreTime(now);
    }
    if (request.getFinalScore() != null) {
        score.setFinalScore(request.getFinalScore());
        score.setFinalScoreTime(now);
    }

    // 如果所有成绩都有,计算总分和绩点
    if (score.getUsualScore() != null && score.getMidtermScore() != null &&
        score.getExperimentScore() != null && score.getFinalScore() != null) {

        // 使用默认权重: 平时20% + 期中20% + 实验20% + 期末40%
        BigDecimal totalScore = score.getUsualScore().multiply(new BigDecimal("0.2"))
                .add(score.getMidtermScore().multiply(new BigDecimal("0.2")))
                .add(score.getExperimentScore().multiply(new BigDecimal("0.2")))
                .add(score.getFinalScore().multiply(new BigDecimal("0.4")))
                .setScale(2, RoundingMode.HALF_UP);

        score.setTotalScore(totalScore);
        score.setGradePoint(calculateGradePoint(totalScore));
        score.setTotalScoreTime(now);
    }

    if (score.getId() == null) {
        scoreMapper.insert(score);
    } else {
        scoreMapper.update(score);
    }
}

/**
 * 计算绩点
 */
private BigDecimal calculateGradePoint(BigDecimal totalScore) {
    double score = totalScore.doubleValue();
    if (score >= 90) return new BigDecimal("4.0");
    if (score >= 85) return new BigDecimal("3.7");
    if (score >= 82) return new BigDecimal("3.3");
    if (score >= 78) return new BigDecimal("3.0");
    if (score >= 75) return new BigDecimal("2.7");
    if (score >= 72) return new BigDecimal("2.3");
    if (score >= 68) return new BigDecimal("2.0");
    if (score >= 64) return new BigDecimal("1.5");
    if (score >= 60) return new BigDecimal("1.0");
    return new BigDecimal("0.0");
}
```

#### 12.2 数据访问层实现

**12.2.1 Mapper 接口设计**
- **统一接口**：每个实体对应一个 Mapper 接口，如 [StudentMapper](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/mapper/StudentMapper.java)、[TeacherMapper](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/mapper/TeacherMapper.java) 等
- **查询方法**：提供基础的 CRUD 操作以及业务相关的复杂查询方法
- **关联查询**：通过 MyBatis 的关联查询功能获取包含关联数据的复杂对象

**12.2.2 MyBatis XML 映射文件**
- **SQL 映射**：在 [src/main/resources/mapper](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/resources/mapper) 目录下为每个 Mapper 接口提供对应的 XML 映射文件
- **动态 SQL**：使用 MyBatis 的动态 SQL 功能处理复杂的查询条件
- **结果映射**：定义复杂对象的结果映射关系，处理多表关联查询的结果

#### 12.3 AI 集成功能

**12.3.1 AI 服务设计**
- **服务类**：[AIService](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/service/AIService.java) 负责与大语言模型交互
- **模型集成**：通过 LangChain4j 框架集成通义千问模型
- **上下文构建**：根据用户角色和请求参数，从数据库获取相关数据并构建提示词上下文

以下为学生AI咨询功能的核心实现代码：

```
/**
 * 学生咨询 - 根据成绩提供学习建议
 */
public String studentConsult(Long studentId, String message) {
    // 获取学生所有成绩
    List<Score> scores = scoreMapper.findByStudentId(studentId);

    if (scores.isEmpty()) {
        return "您还没有任何成绩记录。请先选课并等待老师录入成绩。";
    }

    // 构建成绩上下文
    StringBuilder context = new StringBuilder();
    context.append("学生成绩情况:\n");

    double totalAverage = 0;
    int completedCourses = 0;

    for (Score score : scores) {
        context.append(String.format("- 课程: %s, ", score.getTeachingClass().getCourse().getCourseName()));

        if (score.getTotalScore() != null) {
            context.append(String.format("总分: %.2f, ", score.getTotalScore()));
            context.append(String.format("绩点: %.1f, ", score.getGradePoint()));
            context.append("成绩构成: ");
            if (score.getUsualScore() != null)
                context.append(String.format("平时%.0f, ", score.getUsualScore()));
            if (score.getMidtermScore() != null)
                context.append(String.format("期中%.0f, ", score.getMidtermScore()));
            if (score.getExperimentScore() != null)
                context.append(String.format("实验%.0f, ", score.getExperimentScore()));
            if (score.getFinalScore() != null)
                context.append(String.format("期末%.0f", score.getFinalScore()));

            totalAverage += score.getTotalScore().doubleValue();
            completedCourses++;
        } else {
            context.append("成绩尚未完整录入");
        }
        context.append("\n");
    }

    if (completedCourses > 0) {
        totalAverage /= completedCourses;
        context.append(String.format("\n平均分: %.2f\n", totalAverage));
    }

    // 构建完整提示词
    String prompt = String.format("""
            你是一位资深的计算机专业学业导师,精通各类编程语言、算法、数据库等计算机课程的核心知识点。

            根据以下学生的成绩情况,回答学生的问题并提供专业建议。

            %s

            学生的问题: %s

            回答要求:
            1. **成绩分析**: 对学生的成绩进行客观分析,指出优势科目和薄弱环节
            2. **知识点诊断**: 如果学生问到具体课程(如Java、数据结构、数据库等),必须结合该课程的核心知识点进行分析
               - 例如Java课程: 应提到面向对象编程(封装、继承、多态)、集合框架、异常处理、多线程、IO流等具体知识点
               - 例如数据结构: 应提到线性表、栈、队列、树、图、排序算法、查找算法等
               - 例如数据库: 应提到SQL语句、索引优化、事务处理、范式设计等
            3. **学习建议**: 针对薄弱知识点,给出具体的学习资源和练习方法
               - 推荐教材章节、在线课程、练习项目等
               - 给出代码练习建议和算法题推荐
            4. **实践指导**: 建议通过具体的项目实践来巩固知识
            5. **职业规划**: 根据成绩特点,给出未来技术方向的建议

            请用专业但易懂的语气回答,结合具体的技术术语和知识点,让建议更有针对性和可操作性。
            字数控制在400字以内。
            """, context.toString(), message);

    return chatLanguageModel.generate(prompt);
}
```

**12.3.2 流式响应实现**
- **SSE 支持**：使用 Spring 的 [SseEmitter](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/controller/StudentController.java#L145-L170) 实现 Server-Sent Events
- **异步处理**：在 Controller 中直接调用 AI 服务的流式方法，避免 SecurityContext 传递问题
- **实时反馈**：通过流式响应实现类似打字机效果的 AI 回答显示

**12.3.3 提示词工程**
- **上下文注入**：将学生的成绩数据或班级的统计信息作为上下文注入到提示词中
- **角色设定**：设定 AI 为学业导师或教学分析专家，提高回答的专业性
- **结构化输出**：通过提示词引导 AI 生成结构化的回答内容

#### 12.4 安全与性能优化

**12.4.1 安全机制**
- **JWT 认证**：使用 [JwtUtil](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/security/JwtUtil.java) 生成和验证 JWT Token
- **权限控制**：通过 Spring Security 配置不同 URL 的访问权限
- **密码加密**：使用 BCrypt 算法对用户密码进行加密存储

**12.4.2 性能优化**
- **数据库优化**：在关键查询中使用索引，优化 SQL 查询性能
- **事务管理**：在关键业务操作中使用 @Transactional 注解确保数据一致性
- **连接池配置**：配置 MySQL 连接池参数以提高数据库访问性能

#### 12.5 管理员控制器实现

**12.5.1 管理员控制器设计**
- **主要功能**：[AdminController](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/controller/AdminController.java) 负责处理管理员端的所有API请求
- **权限控制**：通过 `@PreAuthorize("hasRole('SUPER_ADMIN')")` 注解确保只有超级管理员可以访问
- **功能模块**：提供学生、教师、课程和教学班的创建和管理API

**12.5.2 学生管理API**
- **创建学生**：`POST /api/admin/students` - 接收学生注册请求，创建学生用户账号和档案信息
- **数据验证**：使用 `@Valid` 注解进行请求参数验证，确保数据完整性
- **错误处理**：捕获异常并返回统一格式的错误信息

以下为创建学生的API实现代码：

```java
/**
 * 新增学生（创建用户 + 学生档案）
 */
@PostMapping("/students")
public Result<Student> createStudent(@Valid @RequestBody StudentRegisterRequest request) {
    try {
        Student student = adminService.createStudent(request);
        return Result.success("创建学生成功", student);
    } catch (Exception e) {
        return Result.error("创建学生失败: " + e.getMessage());
    }
}
```

**12.5.3 教师管理API**
- **创建教师**：`POST /api/admin/teachers` - 接收教师注册请求，创建教师用户账号和档案信息
- **数据验证**：验证教工号格式和必填字段
- **权限控制**：确保只有超级管理员可以访问

**12.5.4 课程管理API**
- **创建课程**：`POST /api/admin/courses` - 创建新的课程信息
- **数据验证**：验证课程编号唯一性，确保课程信息完整性
- **返回结果**：返回创建的课程信息，包含自动生成的ID

**12.5.5 教学班管理API**
- **创建教学班**：`POST /api/admin/teaching-classes` - 为课程分配授课教师，创建教学班
- **关联验证**：验证课程和教师的有效性
- **唯一性检查**：确保同一学期的教学班编号不重复

以下为创建教学班的API实现代码：

```java
/**
 * 新增教学班（为课程分配授课教师）
 */
@PostMapping("/teaching-classes")
public Result<TeachingClass> createTeachingClass(@Valid @RequestBody AdminCreateTeachingClassRequest request) {
    try {
        TeachingClass teachingClass = adminService.createTeachingClass(request);
        return Result.success("创建教学班成功", teachingClass);
    } catch (Exception e) {
        return Result.error("创建教学班失败: " + e.getMessage());
    }
}
```

**12.5.6 数据查询API**
- **课程列表**：`GET /api/admin/courses` - 获取所有课程信息
- **教师列表**：`GET /api/admin/teachers` - 获取所有教师信息
- **统一响应**：使用Result类统一返回格式，便于前端处理

### 13. 人工智能应用情况

**使用了什么 AI：** 阿里云通义千问 (Qwen-Max) 大语言模型。

**如何使用 AI：**
通过 `langchain4j` 框架接入。在 [AIService](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/service/AIService.java) 中，系统会先查询数据库获取用户的相关数据（如学生的所有成绩、班级的所有学生成绩），将这些数据转化为自然语言描述，作为 "System Prompt" 或上下文注入到 LLM 中，从而让 AI 能够基于事实数据回答用户问题。

**完成了什么任务：**
1.  **学业诊断**：分析学生成绩短板。
2.  **教学建议**：分析班级整体表现，指出共性问题。

**使用 AI 的截图：**
*(此处请在运行项目后截图：学生端点击"AI 学业顾问"进行对话的界面，以及教师端"AI 教学分析"的界面)*

### 14. 其他需要论述和补充的内容

本项目移除了 Redis 依赖，简化了部署流程，专注于业务逻辑和 AI 应用的结合。

---

## 四、实验结果及分析

### 1. 源程序调试过程
在开发过程中遇到了以下问题并已解决：
- **跨域问题**：通过在控制器类上添加 `@CrossOrigin` 注解解决。
- **JWT Token 过期处理**：实现了 Token 验证和异常处理机制，在 [GlobalExceptionHandler.java](file:///Users/nissoncx/code/Java-Course-Exp-main/Exp04/src/main/java/com/cqu/exp04/exception/GlobalExceptionHandler.java) 中统一处理认证异常。
- **AI 响应超时优化**：设置 SSE 连接超时时间为 120 秒，确保长对话的正常进行。
- **数据库连接问题**：配置了 MySQL 时区和连接参数，确保数据的正确存储和检索。
- **成绩计算精度问题**：使用 BigDecimal 进行成绩计算，避免浮点数精度问题。
- **SSE 流式输出问题**：在 Controller 中直接调用流式 AI 服务，避免了 SecurityContext 传递问题。

### 2. 实验总结与体会
通过本次实验，我深入理解了 Spring Boot 开发流程，掌握了以下关键技术点：
- **分层架构设计**：学会了如何合理划分 Controller、Service、Mapper 层，实现业务逻辑的解耦。
- **安全认证机制**：通过 JWT 和 Spring Security 实现了无状态认证，理解了现代 Web 应用的安全设计。
- **AI 集成开发**：掌握了 LangChain4j 框架的使用方法，学会了如何将 AI 能力集成到业务系统中。
- **流式响应技术**：通过 SSE 实现了 AI 回答的流式输出，提升了用户体验。
- **数据建模能力**：通过设计合理的实体类和数据库表结构，实现了复杂的业务逻辑。

本次实验让我深刻认识到 AI 技术在传统业务系统中的巨大潜力，通过将大语言模型与具体业务数据结合，可以为用户提供更加智能化的服务体验。同时，也让我更加熟练掌握了 Spring Boot 全栈开发的技能，为今后的项目开发奠定了坚实基础。